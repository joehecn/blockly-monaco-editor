---
filename: 4-模块契约.md
title: 模块接口契约 - 三层双流状态模型
version: 2.1.0
description: 完整的接口契约定义，按功能域分组，包含详细实现状态和约束条件
---
# 模块接口契约 - 三层双流状态模型

> **文档定位**：本文档定义了系统中所有模块的接口规范，是开发和测试的唯一依据。
>
> 📋 **相关文档**：
> - 设计原则 → [核心原则](2-核心原则.md) 
> - 系统架构 → [系统模型](3-系统模型.md)
> - 实现指南 → [实施指南](5-实施指南.md)

## 📝 契约总则

### 接口设计原则
- **接口优先**：先定义接口，再实现功能
- **类型安全**：使用TypeScript强类型约束
- **单一职责**：每个接口只做一件事
- **无状态设计**：尽量避免接口依赖上下文状态
- **错误处理**：明确的错误返回类型和处理机制

### 版本兼容性承诺
- **向后兼容**：接口变更不破坏现有实现
- **废弃标记**：所有即将废弃的接口必须有明确标记
- **版本控制**：接口版本与系统版本保持同步

## 🔄 状态管理接口（12个）

| 接口 | 状态 | 关键约束 | 描述 |
|---|---|---|---|
| transitionTo() | 已实现 | 必须遵守状态转换规则 | 安全地将系统状态转换到目标状态 |
| getCurrentState() | 已实现 | 无 | 获取当前系统状态快照 |
| canTransitionTo() | 已实现 | 基于当前状态和约束检查 | 检查是否可以转换到目标状态 |
| registerStateListener() | 已实现 | 支持多监听器注册 | 注册状态变化监听器 |
| unregisterStateListener() | 已实现 | 必须提供正确的监听器引用 | 移除状态变化监听器 |
| createStateMachine() | 已实现 | 单例模式 | 创建或获取状态机实例 |
| resetStateMachine() | 已实现 | 会丢弃所有未保存的更改 | 重置状态机到初始状态 |
| isLocked() | 已实现 | 无 | 检查系统是否处于锁定状态 |
| lockSystem() | 已实现 | 会生成锁定ID | 锁定系统以进行独占操作 |
| unlockSystem() | 已实现 | 必须提供正确的锁定ID | 解除系统锁定 |
| getStateTransitionHistory() | 待实施 | 按时间倒序排列 | 获取状态转换历史记录 |
| enableStateLogging() | 已实现 | 开发模式下可用 | 启用详细的状态变化日志 |

### 状态管理接口详情
<details>
<summary>点击查看详细接口定义</summary>

```typescript
// 状态定义
enum SystemState {
  ALL_SYNCED = 'ALL_SYNCED',
  BLOCKLY_DIRTY = 'BLOCKLY_DIRTY',
  MONACO_DIRTY = 'MONACO_DIRTY',
  SYNC_PROCESSING = 'SYNC_PROCESSING'
}

// 状态转换参数
interface TransitionOptions {
  source?: 'blockly' | 'monaco' | 'system';
  reason?: string;
  metadata?: Record<string, any>;
}

// 状态变化监听器
type StateChangeListener = (
  newState: SystemState,
  oldState: SystemState,
  transitionInfo: TransitionInfo
) => void;

// 状态机核心接口
interface StateMachine {
  // 状态转换方法
  transitionTo(targetState: SystemState, options?: TransitionOptions): Promise<boolean>;
  
  // 状态查询方法
  getCurrentState(): SystemState;
  canTransitionTo(targetState: SystemState): boolean;
  
  // 监听器管理
  registerStateListener(listener: StateChangeListener): void;
  unregisterStateListener(listener: StateChangeListener): void;
  
  // 系统控制方法
  resetStateMachine(): Promise<void>;
  
  // 锁定管理
  isLocked(): boolean;
  lockSystem(reason: string): string | null;
  unlockSystem(lockId: string): boolean;
  
  // 高级功能（可选）
  getStateTransitionHistory(limit?: number): StateTransitionHistory[];
  enableStateLogging(enabled: boolean): void;
}

// 工厂函数
function createStateMachine(options?: StateMachineOptions): StateMachine;
```
</details>

## 🎯 超时管理接口（8个）

| 接口 | 状态 | 关键约束 | 描述 |
|---|---|---|---|
| setTimeoutForSync() | 已实现 | 必须与防抖设置协调 | 设置同步操作的超时时间 |
| setTimeoutForValidation() | 已实现 | 必须与防抖设置协调 | 设置验证操作的超时时间 |
| setTimeoutForErrorRecovery() | 已实现 | 必须大于同步超时 | 设置错误恢复的超时时间 |
| registerTimeoutHandler() | 已实现 | 支持多处理器注册 | 注册超时处理器 |
| unregisterTimeoutHandler() | 已实现 | 必须提供正确的处理器引用 | 移除超时处理器 |
| getTimeoutSettings() | 已实现 | 无 | 获取当前所有超时设置 |
| updateTimeoutSettings() | 已实现 | 运行时可调整 | 更新超时设置 |
| enableTimeoutLogging() | 已实现 | 开发模式下可用 | 启用详细的超时日志 |

## 🖥️ UI反馈接口（15个）

| 接口 | 状态 | 关键约束 | 描述 |
|---|---|---|---|
| updateStatusIndicator() | 已实现 | 必须遵循状态颜色规范 | 更新状态栏指示器 |
| showSyncAnimation() | 已实现 | 必须可取消 | 显示同步动画 |
| hideSyncAnimation() | 已实现 | 无 | 隐藏同步动画 |
| showErrorNotification() | 已实现 | 必须提供恢复选项 | 显示错误通知 |
| showSuccessNotification() | 已实现 | 自动消失 | 显示成功通知 |
| showWarningNotification() | 已实现 | 自动消失 | 显示警告通知 |
| registerUIFeedbackHandler() | 已实现 | 支持多处理器注册 | 注册UI反馈处理器 |
| unregisterUIFeedbackHandler() | 已实现 | 必须提供正确的处理器引用 | 移除UI反馈处理器 |
| updateBlocklyEditorState() | 已实现 | 必须支持禁用/启用编辑 | 更新Blockly编辑器状态 |
| updateMonacoEditorState() | 已实现 | 必须支持禁用/启用编辑 | 更新Monaco编辑器状态 |
| highlightActiveEditor() | 已实现 | 视觉区分 | 高亮显示当前活动的编辑器 |
| createUndoButton() | 已实现 | 必须遵守可用性规范 | 创建撤销按钮 |
| createRedoButton() | 已实现 | 必须遵守可用性规范 | 创建重做按钮 |
| enableAutoSaveButton() | 待实施 | 必须提供确认对话框 | 启用自动保存按钮 |
| disableAutoSaveButton() | 待实施 | 无 | 禁用自动保存按钮 |

## 🔄 数据转换接口（13个）

| 接口 | 状态 | 关键约束 | 描述 |
|---|---|---|---|
| blocklyToJson() | 已实现 | 必须处理所有Blockly元素 | 将Blockly数据转换为JSON |
| jsonToBlockly() | 已实现 | 必须处理所有JSON属性 | 将JSON数据转换为Blockly |
| monacoToJson() | 已实现 | 必须处理所有Monaco内容 | 将Monaco数据转换为JSON |
| jsonToMonaco() | 已实现 | 必须处理所有JSON属性 | 将JSON数据转换为Monaco |
| validateJson() | 已实现 | 必须使用JSON Schema | 验证JSON数据的有效性 |
| registerTransformer() | 已实现 | 支持自定义转换逻辑 | 注册自定义数据转换器 |
| unregisterTransformer() | 已实现 | 必须提供正确的转换器引用 | 移除自定义数据转换器 |
| createDefaultTransformer() | 已实现 | 必须返回可用的转换器 | 创建默认数据转换器 |
| transformData() | 已实现 | 必须处理所有转换场景 | 通用数据转换方法 |
| isTransformable() | 已实现 | 无 | 检查数据是否可转换 |
| getTransformationErrors() | 已实现 | 按严重性排序 | 获取转换错误信息 |
| enableTransformationLogging() | 已实现 | 开发模式下可用 | 启用详细的转换日志 |
| registerRetryPolicy() | 待实施 | 支持指数退避配置 | 注册转换重试策略

## ⏱️ 时序控制接口（10个）

### 接口约束说明
**重要约束**：核心同步流程必须使用固定300ms防抖值，此接口仅适用于非核心场景

> 📌 **接口使用范围**：README.md的自定义参数接口仅适用于非核心模块，核心同步必须调用固定参数接口。

| 接口 | 状态 | 关键约束 | 描述 |
|---|---|---|---|
| createDebounceFunction() | 已实现 | 必须支持取消 | 创建防抖函数 |
| createThrottleFunction() | 已实现 | 必须支持取消 | 创建节流函数 |
| setDebounceDelay() | 已实现 | 必须大于节流间隔 | 设置防抖延迟时间 |
| setThrottleInterval() | 已实现 | 必须小于防抖延迟 | 设置节流间隔时间 |
| validateDebounceConfig() | 待实施 | 核心参数300ms/100ms不可修改 | 验证时序配置不违反核心契约 |
| getTimingSettings() | 已实现 | 无 | 获取当前时序设置 |
| updateTimingSettings() | 已实现 | 运行时可调整 | 更新时序设置 |
| registerTimingHandler() | 已实现 | 支持多处理器注册 | 注册时序处理器 |
| unregisterTimingHandler() | 已实现 | 必须提供正确的处理器引用 | 移除时序处理器 |
| handleUserEdit() | 已实现 | 必须支持连续编辑 | 处理用户编辑操作 |
| enableTimingLogging() | 已实现 | 开发模式下可用 | 启用详细的时序日志 |

## 🔒 原子操作接口（9个）

| 接口 | 状态 | 关键约束 | 描述 |
|---|---|---|---|
| createAtomicOperation() | 已实现 | 必须支持回滚 | 创建原子操作 |
| executeAtomicOperation() | 已实现 | 必须支持异步 | 执行原子操作 |
| cancelAtomicOperation() | 已实现 | 必须支持部分执行的回滚 | 取消原子操作 |
| completeAtomicOperation() | 已实现 | 无 | 完成原子操作 |
| registerOperationHandler() | 已实现 | 支持多处理器注册 | 注册操作处理器 |
| unregisterOperationHandler() | 已实现 | 必须提供正确的处理器引用 | 移除操作处理器 |
| isOperationAtomic() | 已实现 | 无 | 检查操作是否是原子的 |
| getOperationStatus() | 已实现 | 无 | 获取操作状态 |
| enableOperationLogging() | 已实现 | 开发模式下可用 | 启用详细的操作日志 |

## 💾 版本管理接口（12个）

| 接口 | 状态 | 关键约束 | 描述 |
|---|---|---|---|
| createVersionSnapshot() | 已实现 | 只在ALL_SYNCED状态下调用 | 创建版本快照 |
| restoreVersionSnapshot() | 已实现 | 必须是原子操作 | 恢复版本快照 |
| getVersionHistory() | 已实现 | 按时间倒序排列 | 获取版本历史记录 |
| getCurrentVersion() | 已实现 | 无 | 获取当前版本信息 |
| registerVersionHandler() | 已实现 | 支持多处理器注册 | 注册版本处理器 |
| unregisterVersionHandler() | 已实现 | 必须提供正确的处理器引用 | 移除版本处理器 |
| deleteVersionSnapshot() | 已实现 | 不能删除当前版本 | 删除版本快照 |
| clearVersionHistory() | 已实现 | 必须提供确认对话框 | 清除版本历史 |
| isVersionRestorable() | 已实现 | 无 | 检查版本是否可恢复 |
| exportVersionSnapshot() | 待实施 | 必须支持JSON格式 | 导出版本快照 |
| importVersionSnapshot() | 待实施 | 必须支持验证 | 导入版本快照 |
| enableVersionLogging() | 已实现 | 开发模式下可用 | 启用详细的版本日志 |

## ❌ 错误处理接口（8个）

| 接口 | 状态 | 关键约束 | 描述 |
|---|---|---|---|
| handleError() | 已实现 | 必须遵循错误恢复优先级 | 处理系统错误 |
| registerErrorHandler() | 已实现 | 支持多处理器注册 | 注册错误处理器 |
| unregisterErrorHandler() | 已实现 | 必须提供正确的处理器引用 | 移除错误处理器 |
| getLastError() | 已实现 | 无 | 获取最后一个错误信息 |
| getErrorHistory() | 已实现 | 按时间倒序排列 | 获取错误历史记录 |
| isRecoverableError() | 已实现 | 无 | 检查错误是否可恢复 |
| recoverFromError() | 已实现 | 必须支持多步骤恢复 | 从错误中恢复 |
| enableErrorLogging() | 已实现 | 开发模式下可用 | 启用详细的错误日志 |

## 📚 工具函数接口（10个）

| 接口 | 状态 | 关键约束 | 描述 |
|---|---|---|---|
| deepClone() | 已实现 | 必须处理循环引用 | 深拷贝对象 |
| deepMerge() | 已实现 | 必须处理冲突 | 深合并对象 |
| isEqual() | 已实现 | 必须处理复杂对象 | 深度比较对象 |
| createId() | 已实现 | 必须唯一 | 创建唯一ID |
| formatDate() | 已实现 | 支持多种格式 | 格式化日期 |
| parseJson() | 已实现 | 必须支持错误处理 | 解析JSON字符串 |
| stringifyJson() | 已实现 | 必须支持循环引用 | 序列化JSON对象 |
| getType() | 已实现 | 必须识别复杂类型 | 获取值的类型 |
| isEmpty() | 已实现 | 必须处理所有类型 | 检查值是否为空 |
| assert() | 已实现 | 开发模式下可用 | 断言函数 |

## 🧩 技术矩阵

| 技术点 | 原则关联 | 架构位置 | 契约条款 | 实现模块 |
|---|---|---|---|---|
| 四状态模型 | 原则1,3 | 系统模型§2 | 契约§3.1 | 状态管理 |
| 防抖300ms | 原则2 | 实施指南§4 | 契约§4.5 | 时序控制 |
| 三层数据流 | 原则1,5 | 系统模型§1 | 契约§2.1 | 数据转换 |
| 版本管理 | 原则5 | 系统模型§4 | 契约§5.2 | 错误处理 |
| 单一编辑权 | 原则3 | 系统模型§2 | 契约§3.3 | 状态管理 |
| 错误恢复优先级 | 原则5 | 系统模型§4 | 契约§6.1 | 错误处理 |
| 用户操作优先 | 原则2 | 核心原则§2 | 契约§4.1 | 时序控制 |
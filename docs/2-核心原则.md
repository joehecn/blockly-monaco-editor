---
filename: 2-核心原则.md
title: 三层双流状态模型 - 核心指导原则
version: 2.1.0
description: 三层双流状态模型的核心设计哲学和不可违背原则，包含验证标准和原则追溯标记
---
# 三层双流状态模型 - 核心指导原则

> **最高指导原则**：在保证数据一致性的前提下，为用户提供流畅的编辑体验。
> 
> 📚 **文档导航**：本文是设计哲学文档，如需了解具体实现细节请参考 [系统模型](3-系统模型.md)，接口定义请参考 [模块契约](4-模块契约.md)

## 💡 核心设计哲学

**关键洞察**：分布式数据系统中的物理不一致是不可避免的现实，但可以通过精心设计的状态机将其转化为受控的逻辑一致状态。

**设计智慧**：
- **物理层面**：三层数据必然存在瞬时不一致（转换时间、异步操作、浏览器渲染延迟）
- **逻辑层面**：通过四状态模型（含临时状态）为每种物理不一致赋予明确的语义和收敛路径
- **用户感知**：用户感受到的是逻辑一致性，而不是底层的物理复杂性
- **工程价值**：将不可控的混沌转化为可预测、可调试、可维护的状态机

## 🏗️ 系统架构基础

### 三层数据流架构
```
Blockly编辑器(UI层) ↔ JSON结构(权威层) ↔ Monaco编辑器(UI层)
```

**架构说明**：
- **Blockly编辑器(UI层)**：包含用户交互的块结构
- **JSON结构(权威层)**：作为数据的权威源
- **Monaco编辑器(UI层)**：代码字符串表示
- 三层语义完全一致时，表示系统处于ALL_SYNCED状态

## 🎯 不可违背的五大核心原则

### 1. 数据一致性至上原则
[↑ 追溯：ADR-001, ADR-003]
[↓ 实现：状态管理模块]

**核心理念**：通过状态机设计将不可避免的物理不一致转化为受控的逻辑一致状态
- **物理现实**：三层数据在物理上必然存在瞬时不一致（转换时间、异步操作、浏览器渲染延迟）
- **逻辑抽象**：通过四状态模型（含临时状态）将物理不一致映射为逻辑上受控的状态转换
- **状态机保证**：每个状态都有明确的数据一致性语义和收敛路径
- **权威数据源**：中间结构层（JSON结构）是系统的逻辑权威源，其他层级向其收敛
- **收敛保证**：SYNC_PROCESSING状态确保物理不一致向逻辑一致状态收敛（超时5秒）

#### 验证标准
- 非SYNC_PROCESSING状态时，至少一侧数据与中间结构一致
- 系统状态转换必须保证数据语义的一致性
- 从任何状态都能收敛到ALL_SYNCED状态
- 同步超时机制（5秒）必须可靠工作

### 2. 用户操作优先原则
[↑ 追溯：ADR-001]
[↓ 实现：时序控制模块]

**目标约束**：用户编辑操作具有最高优先级，系统响应时间必须在可接受范围内
- **响应要求**：用户输入延迟 < 50ms，关键路径绝不阻塞
- **让路机制**：非关键系统操作（日志、统计）异步执行
- **优雅降级**：高并发时可暂停非关键功能以保证用户响应

#### 验证标准
- 用户操作响应时间必须小于50ms
- 同步处理不能阻塞用户界面响应
- 防抖300ms/节流100ms参数必须严格遵守
- 高负载下优先保证用户操作流畅性

### 3. 单一编辑权原则
[↑ 追溯：ADR-003]
[↓ 实现：状态管理模块]

**目标约束**：在稳定状态下只允许一个UI层接受用户编辑，SYNC_PROCESSING状态下允许来源端继续编辑
- **UI层控制**：通过编辑器禁用机制确保逻辑上的单一编辑权
- **状态映射**：编辑权与系统四状态模型（含临时状态）严格对应
- **SYNC_PROCESSING状态例外**：在SYNC_PROCESSING状态时，来源端可继续编辑
- **冲突预防**：防止同时编辑导致的数据竞争和状态混乱

#### 验证标准
- ALL_SYNCED状态时双向可编辑
- DIRTY状态时仅允许一侧编辑
- SYNC_PROCESSING状态时允许来源端继续编辑
- 编辑权限必须与系统状态严格对应

### 4. 状态透明原则
[↑ 追溯：ADR-003]
[↓ 实现：UI反馈模块]

**目标约束**：用户应该能够理解系统当前状态，但不需要了解所有技术细节
- **核心状态可视化**：ALL_SYNCED、DIRTY、SYNC_PROCESSING状态必须有清晰的视觉反馈
- **操作指引**：在DIRTY和SYNC_PROCESSING状态下提示用户当前的限制
- **进度反馈**：长时间的SYNC_PROCESSING状态应显示进度信息
- **优雅的技术隐藏**：用户不需要理解复杂架构的技术细节

#### 验证标准
- 所有状态变化必须在界面上清晰反映
- 界面状态指示器必须与系统状态严格一致
- 状态转换必须有明确的视觉反馈
- 用户操作提示必须与当前状态相符

### 5. 错误恢复原则
[↑ 追溯：ADR-001]
[↓ 实现：错误处理模块]

**目标约束**：系统必须为常见错误情况提供自动恢复，为严重错误提供手动恢复路径
- **分层自动恢复**：用户输入错误自动提示，转换错误自动重试，系统故障触发保护机制
- **手动恢复机制**：版本回退作为最后的安全网，用户可主动触发
- **数据保护优先级**：用户正在编辑的内容 > 历史数据 > 系统状态
- **恢复时间限制**：自动恢复应在30秒内完成，否则提示用户手动干预

### 错误恢复原则补充
SYNC_PROCESSING状态超时（5秒）后：
1. 自动回退到来源DIRTY状态
2. 触发STATE_RECOVERED事件
3. 保留用户最后输入值

#### 验证标准
- 任何错误都有明确的恢复路径
- 自动恢复机制成功率达到100%
- 版本回退功能必须能从任意状态恢复
- 错误提示必须清晰明确并提供解决方案

## 📊 四状态模型 - 精确控制规则

完整状态转换规则见[3-系统模型.md#四状态模型---精确控制规则](3-系统模型.md#四状态模型---精确控制规则)

## ⚡ 关键行为约束

### 状态转换约束
```
状态机设计的核心约束：
1. 每个状态转换都必须有明确的触发条件和目标状态
2. 状态转换过程中系统保持逻辑可预测性，即使物理层异步执行
3. SYNC_PROCESSING状态设置收敛超时（5秒），确保不会陷入无限转换
4. 状态转换的原子性是逻辑层面的，物理层面允许分步执行
5. 错误状态必须能映射回已知的稳定状态，避免状态机失控
6. 用户操作只能在逻辑上合法的状态下进行，物理实现异步跟进
```

## 🧠 物理与逻辑的映射智慧

### 物理不一致的根本原因
1. **计算时间**：数据转换、验证、序列化都需要CPU时间
2. **异步操作**：为了不阻塞用户，系统操作必须异步执行
3. **DOM渲染延迟**：浏览器更新UI需要重绘和重排时间
4. **JavaScript事件循环**：异步任务在事件队列中的执行顺序和时机
5. **内存分配时间**：大型数据结构的创建和垃圾回收
6. **编辑器API调用**：Blockly和Monaco的API调用不是瞬时完成的

### 状态机的抽象价值
1. **语义化物理状态**：将"正在转换"抽象为"SYNC_PROCESSING状态"
2. **明确责任边界**：每个状态都有明确的数据权威源
3. **可预测的行为**：即使底层异步，上层逻辑依然确定
4. **优雅的错误处理**：任何异常都可以映射为状态转换失败
5. **用户体验保证**：用户看到的是稳定的逻辑状态，而不是混乱的物理过程

### 防抖节流约束
```
不可违背的时序规则：
1. 防抖300ms：主策略，用户停止编辑300ms后触发状态转换（从DIRTY状态进入SYNC_PROCESSING状态）
2. 节流100ms：安全阀，在持续编辑过程中，每100ms提供一次实时反馈（不触发状态转换）
3. 待处理值：单一覆盖，不累积 - 新输入会覆盖等待处理的旧输入，避免队列堆积
4. 验证独立：防抖和节流互不干扰 - 节流反馈不影响防抖计时
5. SYNC_PROCESSING状态处理：同步过程中用户继续编辑会被排队，等待当前同步完成后立即处理
6. 参数不可变性：防抖300ms和节流100ms为**核心契约固定值**，任何实现都必须严格遵守，禁止任何形式的修改
```

> 注：300ms/100ms参数值为**不可修改的核心契约固定值**，所有模块必须严格遵守，详见[模块契约](4-模块契约.md) Phase4契约规范。
---
filename: 5-å®æ–½æŒ‡å—.md
title: åˆ†é˜¶æ®µå®æ–½æŒ‡å— - ä¸‰å±‚åŒæµçŠ¶æ€æ¨¡å‹
version: 2.1.0
description: è¯¦ç»†çš„åˆ†é˜¶æ®µå®æ–½è®¡åˆ’å’ŒæŠ€æœ¯å®ç°ç­–ç•¥ï¼Œä»¥é‡Œç¨‹ç¢‘å¡ç‰‡å½¢å¼å‘ˆç°
---
# åˆ†é˜¶æ®µå®æ–½æŒ‡å— - ä¸‰å±‚åŒæµçŠ¶æ€æ¨¡å‹

> **æ–‡æ¡£å®šä½**ï¼šæœ¬æ–‡æ¡£æä¾›è¯¦ç»†çš„å®æ–½è·¯çº¿å›¾å’ŒæŠ€æœ¯å®ç°ç­–ç•¥ï¼Œæ˜¯å¼€å‘å›¢é˜Ÿçš„æ“ä½œæŒ‡å—ã€‚
>
> ğŸ“‹ **ç›¸å…³æ–‡æ¡£**ï¼š
> - è®¾è®¡åŸåˆ™ â†’ [æ ¸å¿ƒåŸåˆ™](2-æ ¸å¿ƒåŸåˆ™.md) 
> - ç³»ç»Ÿæ¶æ„ â†’ [ç³»ç»Ÿæ¨¡å‹](3-ç³»ç»Ÿæ¨¡å‹.md)
> - æ¥å£è§„èŒƒ â†’ [æ¨¡å—å¥‘çº¦](4-æ¨¡å—å¥‘çº¦.md)

## ğŸ“… åˆ†é˜¶æ®µå®æ–½è®¡åˆ’

### Phase 1: æ ¸å¿ƒåŠŸèƒ½æ„å»ºï¼ˆå·²å®Œæˆï¼‰
**å‘¨æœŸ**ï¼š3å‘¨
**æ ¸å¿ƒäº¤ä»˜**ï¼š
- [x] çŠ¶æ€æœºæ ¸å¿ƒå®ç°ï¼ˆSystemStateæšä¸¾ã€çŠ¶æ€è½¬æ¢é€»è¾‘ï¼‰
- [x] JSONåŒå‘è½¬æ¢å¼•æ“ï¼ˆBlockly <-> JSON <-> Monacoï¼‰
- [x] åŸºç¡€UIçŠ¶æ€ç®¡ç†ï¼ˆçŠ¶æ€æ ã€ç¼–è¾‘å™¨çŠ¶æ€åˆ‡æ¢ï¼‰
- [x] åŸºç¡€é”™è¯¯å¤„ç†æœºåˆ¶ï¼ˆç®€å•å›é€€ç­–ç•¥ï¼‰
- [x] åŸºæœ¬çš„æ—¶åºæ§åˆ¶ï¼ˆé˜²æŠ–300msã€èŠ‚æµ100msï¼‰

**æŠ€æœ¯é‡ç‚¹**ï¼š
- ä¿è¯çŠ¶æ€è½¬æ¢çš„åŸå­æ€§å’Œç¡®å®šæ€§
- å®ç°é«˜æ•ˆçš„JSONæ•°æ®åŒå‘è½¬æ¢
- å»ºç«‹åŸºç¡€çš„é”™è¯¯å¤„ç†æ¡†æ¶
- éªŒè¯æ—¶åºæ§åˆ¶æœºåˆ¶çš„æœ‰æ•ˆæ€§

### Phase 2: åŠŸèƒ½å¢å¼ºä¸ç¨³å®šæ€§ä¼˜åŒ–ï¼ˆå·²å®Œæˆï¼‰
**å‘¨æœŸ**ï¼š4å‘¨
**æ ¸å¿ƒäº¤ä»˜**ï¼š
- [x] å®Œæ•´çš„ç‰ˆæœ¬ç®¡ç†ç³»ç»Ÿï¼ˆå¿«ç…§åˆ›å»ºã€å›æ»šï¼‰
- [x] å¢å¼ºçš„é”™è¯¯å¤„ç†ä¸æ¢å¤æœºåˆ¶ï¼ˆå¤šçº§é”™è¯¯å¤„ç†ï¼‰
- [x] é«˜çº§æ—¶åºæ§åˆ¶ï¼ˆè¿ç»­ç¼–è¾‘å¤„ç†ã€ä¼˜å…ˆçº§è°ƒåº¦ï¼‰
- [x] å®Œå–„çš„UIåé¦ˆç³»ç»Ÿï¼ˆåŠ¨ç”»ã€é€šçŸ¥ã€çŠ¶æ€æŒ‡ç¤ºï¼‰
- [x] åŸå­æ“ä½œæ¡†æ¶ï¼ˆäº‹åŠ¡æ”¯æŒã€éƒ¨åˆ†å›æ»šï¼‰
- [ ] é«˜çº§é…ç½®ç³»ç»Ÿï¼ˆå¯é…ç½®çš„çŠ¶æ€è½¬æ¢è§„åˆ™ï¼‰

**æŠ€æœ¯é‡ç‚¹**ï¼š
- ç¡®ä¿ç‰ˆæœ¬å›æ»šçš„å¯é æ€§å’Œä¸€è‡´æ€§
- å®ç°å¤æ‚åœºæ™¯ä¸‹çš„é”™è¯¯æ¢å¤
- ä¼˜åŒ–è¿ç»­ç¼–è¾‘æ—¶çš„ç”¨æˆ·ä½“éªŒ
- å»ºç«‹å¯æ‰©å±•çš„åŸå­æ“ä½œæ¡†æ¶

### Phase 3: æ€§èƒ½ä¼˜åŒ–ä¸é«˜çº§åŠŸèƒ½ï¼ˆè¿›è¡Œä¸­ï¼‰
**å‘¨æœŸ**ï¼š5å‘¨
**æ ¸å¿ƒäº¤ä»˜**ï¼š
- [x] æ€§èƒ½ä¼˜åŒ–ï¼ˆå¤§å‹æ•°æ®å¤„ç†ã€å†…å­˜ç®¡ç†ï¼‰
- [ ] æ•°æ®è½¬æ¢æ¨¡å—å¼‚æ­¥åŒ–æ”¹é€ ï¼ˆWeb Workeré›†æˆï¼‰
- [ ] æ’ä»¶ç³»ç»Ÿï¼ˆè‡ªå®šä¹‰è½¬æ¢å™¨ã€æ‰©å±•ç‚¹ï¼‰
- [ ] å›½é™…åŒ–æ”¯æŒ
- [ ] é«˜çº§é…ç½®ç³»ç»Ÿï¼ˆå®Œæˆï¼‰
- [ ] è‡ªåŠ¨åŒ–æµ‹è¯•æ¡†æ¶ï¼ˆå®Œæ•´è¦†ç›–ï¼‰
- [ ] æ–‡æ¡£è‡ªåŠ¨åŒ–ç”Ÿæˆ

**æŠ€æœ¯é‡ç‚¹**ï¼š
- ä¼˜åŒ–å¤§å‹æ•°æ®å¤„ç†çš„æ€§èƒ½å’Œå†…å­˜å ç”¨
- å»ºç«‹çµæ´»çš„æ’ä»¶æ‰©å±•æœºåˆ¶
- å®ç°å…¨é¢çš„æµ‹è¯•è¦†ç›–
- å®Œå–„æ–‡æ¡£å’Œå¼€å‘å·¥å…·

## Phase3å®æ–½æ³¨æ„äº‹é¡¹
- é«˜çº§é…ç½®ç³»ç»Ÿä¸å¾—ä¿®æ”¹æ ¸å¿ƒå¥‘çº¦å‚æ•°ï¼ˆé˜²æŠ–300ms/èŠ‚æµ100msï¼‰
- é…ç½®ç•Œé¢éœ€æ˜ç¡®æ ‡è¯†ä¸å¯å˜å‚æ•°

### â›” ç»å¯¹çº¦æŸ
é…ç½®ç•Œé¢å¿…é¡»æ˜ç¡®æ ‡è¯†ä¸å¯ä¿®æ”¹å‚æ•°ï¼ˆå¦‚é˜²æŠ–300ms/èŠ‚æµ100msï¼‰ï¼Œ
å¹¶åœ¨ä¿å­˜å‰è°ƒç”¨validateDebounceConfig()è¿›è¡Œå¥‘çº¦éªŒè¯

## ğŸ’¡ æŠ€æœ¯å®ç°ç­–ç•¥

### 1. æ¥å£ä¼˜å…ˆå¼€å‘ç­–ç•¥
```typescript
// å¼€å‘æµç¨‹ç¤ºä¾‹
1. å®šä¹‰æ¥å£å¥‘çº¦ (interface/type)
2. åˆ›å»ºMockå®ç°è¿›è¡Œæµ‹è¯•
3. å®ç°æ ¸å¿ƒé€»è¾‘
4. é›†æˆæµ‹è¯•
5. æ€§èƒ½ä¼˜åŒ–
```

**ä¼˜åŠ¿**ï¼š
- ç¡®ä¿æ¨¡å—é—´æ¾è€¦åˆ
- æ”¯æŒå¹¶è¡Œå¼€å‘
- ä¾¿äºå•å…ƒæµ‹è¯•
- æ¥å£å˜æ›´å¯æ§

### 2. çŠ¶æ€æœºé©±åŠ¨å¼€å‘
```typescript
// çŠ¶æ€é©±åŠ¨çš„å¼€å‘æ¨¡å¼
function handleUserAction(action: UserAction) {
  // 1. æ£€æŸ¥å½“å‰çŠ¶æ€æ˜¯å¦å…è®¸æ­¤æ“ä½œ
  if (!canPerformAction(getCurrentState(), action)) {
    return { success: false, reason: 'Invalid state for action' };
  }
  
  // 2. æ‰§è¡Œæ“ä½œ
  const result = performAction(action);
  
  // 3. æ ¹æ®ç»“æœè½¬æ¢çŠ¶æ€
  if (result.success) {
    transitionTo(nextState, { source: 'user', reason: action.type });
  }
  
  return result;
}
```

**ä¼˜åŠ¿**ï¼š
- ç³»ç»Ÿè¡Œä¸ºå¯é¢„æµ‹
- çŠ¶æ€è½¬æ¢æœ‰è¿¹å¯å¾ª
- é”™è¯¯å¤„ç†ç»Ÿä¸€
- ä¾¿äºè°ƒè¯•å’Œæµ‹è¯•

### 3. æ•°æ®ç±»å‹æ’ä»¶åŒ–
```typescript
// æ•°æ®ç±»å‹æ’ä»¶åŒ–æ¶æ„
interface DataTypePlugin<T> {
  type: string;
  validate(data: any): boolean;
  transformToJson(data: T): Record<string, any>;
  transformFromJson(json: Record<string, any>): T;
  createDefault(): T;
}

// æ³¨å†Œæ’ä»¶
function registerDataTypePlugin<T>(plugin: DataTypePlugin<T>): void {
  // æ³¨å†Œé€»è¾‘
}

// ä½¿ç”¨æ’ä»¶
function transformData<T>(data: T, targetType: string): any {
  const plugin = getDataTypePlugin(typeof data);
  return plugin.transformToJson(data);
}
```

**ä¼˜åŠ¿**ï¼š
- æ”¯æŒå¤šç§æ•°æ®ç±»å‹
- ä¾¿äºæ‰©å±•æ–°ç±»å‹
- æ ¸å¿ƒé€»è¾‘ä¸æ•°æ®ç±»å‹è§£è€¦
- ç»´æŠ¤æˆæœ¬é™ä½

## ğŸ› ï¸ å…³é”®ç»„ä»¶å®ç°

### çŠ¶æ€æœºæ ¸å¿ƒå®ç°
<details>
<summary>ç‚¹å‡»æŸ¥çœ‹çŠ¶æ€æœºæ ¸å¿ƒå®ç°ç¤ºä¾‹</summary>

```typescript
class StateMachineImpl implements StateMachine {
  private currentState: SystemState = SystemState.ALL_SYNCED;
  private listeners: StateChangeListener[] = [];
  private transitionHistory: StateTransitionHistory[] = [];
  private isLocked: boolean = false;
  private lockId: string | null = null;
  private stateLogging: boolean = false;

  async transitionTo(targetState: SystemState, options?: TransitionOptions): Promise<boolean> {
    // æ£€æŸ¥æ˜¯å¦å¯ä»¥è½¬æ¢
    if (!this.canTransitionTo(targetState)) {
      return false;
    }

    // é”å®šæ£€æŸ¥
    if (this.isLocked && targetState !== SystemState.ALL_SYNCED) {
      return false;
    }

    const oldState = this.currentState;
    this.currentState = targetState;

    // è®°å½•å†å²
    const transitionInfo: StateTransitionHistory = {
      fromState: oldState,
      toState: targetState,
      timestamp: Date.now(),
      source: options?.source || 'system',
      reason: options?.reason || '',
      metadata: options?.metadata || {}
    };
    this.transitionHistory.push(transitionInfo);

    // æ—¥å¿—è®°å½•
    if (this.stateLogging) {
      console.log(`State transition: ${oldState} -> ${targetState}`, transitionInfo);
    }

    // é€šçŸ¥ç›‘å¬å™¨
    for (const listener of this.listeners) {
      listener(targetState, oldState, transitionInfo);
    }

    return true;
  }

  // å…¶ä»–æ–¹æ³•å®ç°...
}
```
</details>

### æ—¶åºæ§åˆ¶å®ç°
<details>
<summary>ç‚¹å‡»æŸ¥çœ‹æ—¶åºæ§åˆ¶å®ç°ç¤ºä¾‹</summary>

```typescript
class TimingControllerImpl implements TimingController {
  private debounceDelay: number = 300;
  private throttleInterval: number = 100;
  private debounceTimers: Map<string, NodeJS.Timeout> = new Map();
  private throttleTimers: Map<string, NodeJS.Timeout> = new Map();
  private lastThrottleTimes: Map<string, number> = new Map();
  private handlers: Map<string, TimingHandler> = new Map();
  private timingLogging: boolean = false;

  createDebounceFunction<T extends (...args: any[]) => any>(
    key: string,
    fn: T,
    customDelay?: number
  ): (...args: Parameters<T>) => void {
    const delay = customDelay || this.debounceDelay;
    
    return (...args: Parameters<T>) => {
      // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
      if (this.debounceTimers.has(key)) {
        clearTimeout(this.debounceTimers.get(key)!);
      }

      // è®¾ç½®æ–°çš„å®šæ—¶å™¨
      const timer = setTimeout(() => {
        if (this.timingLogging) {
          console.log(`Debounced function executed: ${key}`);
        }
        fn(...args);
        this.debounceTimers.delete(key);
      }, delay);

      this.debounceTimers.set(key, timer);
    };
  }

  // å…¶ä»–æ–¹æ³•å®ç°...
}
```
</details>

### æ•°æ®è½¬æ¢å®ç°
<details>
<summary>ç‚¹å‡»æŸ¥çœ‹æ•°æ®è½¬æ¢å®ç°ç¤ºä¾‹</summary>

```typescript
class DataTransformerImpl implements DataTransformer {
  private transformers: Map<string, DataTransformerFunction> = new Map();
  private transformationLogging: boolean = false;

  async blocklyToJson(blocklyData: any): Promise<Record<string, any>> {
    try {
      if (!blocklyData || typeof blocklyData !== 'object') {
        throw new Error('Invalid Blockly data');
      }

      // å®ç°Blocklyåˆ°JSONçš„è½¬æ¢é€»è¾‘
      const jsonData: Record<string, any> = {};
      
      // ç¤ºä¾‹è½¬æ¢é€»è¾‘
      if (blocklyData.type) {
        jsonData.type = blocklyData.type;
      }
      
      if (blocklyData.children) {
        jsonData.children = await Promise.all(
          blocklyData.children.map(async (child: any) => 
            this.blocklyToJson(child)
          )
        );
      }

      if (this.transformationLogging) {
        console.log('Blockly to JSON transformation completed');
      }

      return jsonData;
    } catch (error) {
      if (this.transformationLogging) {
        console.error('Blockly to JSON transformation failed:', error);
      }
      throw error;
    }
  }

  // å…¶ä»–è½¬æ¢æ–¹æ³•å®ç°...
}
```
</details>

## âš™ï¸ å¼€å‘ç¯å¢ƒé…ç½®

### å¼€å‘ä¾èµ–
| ä¾èµ–åç§° | ç‰ˆæœ¬ | ç”¨é€” | æ¥æº |
|---|---|---|---|
| TypeScript | ^5.0.0 | ç±»å‹å®‰å…¨çš„JavaScriptè¶…é›† | [npm](https://www.npmjs.com/package/typescript) |
| Blockly | ^8.0.0 | å¯è§†åŒ–ç¼–ç¨‹ç•Œé¢ | [npm](https://www.npmjs.com/package/blockly) |
| Monaco Editor | ^0.30.0 | ä»£ç ç¼–è¾‘å™¨ | [npm](https://www.npmjs.com/package/monaco-editor) |
| Jest | ^29.0.0 | å•å…ƒæµ‹è¯•æ¡†æ¶ | [npm](https://www.npmjs.com/package/jest) |
| ESLint | ^8.0.0 | ä»£ç è´¨é‡å·¥å…· | [npm](https://www.npmjs.com/package/eslint) |
| Prettier | ^2.0.0 | ä»£ç æ ¼å¼åŒ–å·¥å…· | [npm](https://www.npmjs.com/package/prettier) |
| Mermaid | ^10.0.0 | æµç¨‹å›¾å¯è§†åŒ– | [npm](https://www.npmjs.com/package/mermaid) |

### ç¯å¢ƒå˜é‡é…ç½®
<details>
<summary>ç‚¹å‡»æŸ¥çœ‹ç¯å¢ƒå˜é‡é…ç½®ç¤ºä¾‹</summary>

```typescript
// .env.development
STATE_MACHINE_LOGGING=true
TRANSFORMATION_LOGGING=true
TIMING_LOGGING=true
ERROR_LOGGING=true
VERSION_LOGGING=true
OPERATION_LOGGING=true

// æ—¶åºæ§åˆ¶é…ç½®
DEBOUNCE_DELAY=300
THROTTLE_INTERVAL=100

// è¶…æ—¶é…ç½®
SYNC_TIMEOUT=5000
VALIDATION_TIMEOUT=3000
ERROR_RECOVERY_TIMEOUT=10000

// ç‰ˆæœ¬ç®¡ç†é…ç½®
MAX_VERSION_HISTORY=100
AUTO_SAVE_INTERVAL=300000 // 5åˆ†é’Ÿ

// .env.production
STATE_MACHINE_LOGGING=false
TRANSFORMATION_LOGGING=false
TIMING_LOGGING=false
ERROR_LOGGING=true
VERSION_LOGGING=true
OPERATION_LOGGING=false

// æ—¶åºæ§åˆ¶é…ç½®
DEBOUNCE_DELAY=300
THROTTLE_INTERVAL=100

// è¶…æ—¶é…ç½®
SYNC_TIMEOUT=5000
VALIDATION_TIMEOUT=3000
ERROR_RECOVERY_TIMEOUT=10000

// ç‰ˆæœ¬ç®¡ç†é…ç½®
MAX_VERSION_HISTORY=50
AUTO_SAVE_INTERVAL=300000 // 5åˆ†é’Ÿ
```
</details>

## ğŸš€ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### å¤§å‹æ•°æ®å¤„ç†ä¼˜åŒ–
- **å¢é‡æ›´æ–°**ï¼šåªåŒæ­¥å˜åŒ–çš„éƒ¨åˆ†ï¼Œé¿å…å…¨é‡æ›´æ–°
- **è™šæ‹Ÿæ»šåŠ¨**ï¼šå¯¹äºå¤§å‹åˆ—è¡¨æ•°æ®ï¼Œä½¿ç”¨è™šæ‹Ÿæ»šåŠ¨æŠ€æœ¯
- **æ‡’åŠ è½½**ï¼šæŒ‰éœ€åŠ è½½æ•°æ®ï¼Œé¿å…ä¸€æ¬¡æ€§åŠ è½½è¿‡å¤šå†…å®¹
- **Web Worker**ï¼šå°†å¤æ‚è®¡ç®—ç§»è‡³åå°çº¿ç¨‹ï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹

### å†…å­˜ç®¡ç†ä¼˜åŒ–
- **å¼•ç”¨æ¸…ç†**ï¼šåŠæ—¶æ¸…ç†ä¸å†ä½¿ç”¨çš„å¯¹è±¡å¼•ç”¨
- **ç¼“å­˜ç­–ç•¥**ï¼šåˆç†ä½¿ç”¨ç¼“å­˜ï¼Œé¿å…é‡å¤è®¡ç®—
- **å¼±å¼•ç”¨**ï¼šå¯¹äºç¼“å­˜æ•°æ®ï¼Œä½¿ç”¨å¼±å¼•ç”¨é¿å…å†…å­˜æ³„æ¼
- **å†…å­˜ç›‘æ§**ï¼šåœ¨å¼€å‘ç¯å¢ƒä¸­ç›‘æ§å†…å­˜ä½¿ç”¨æƒ…å†µ

### æ¸²æŸ“æ€§èƒ½ä¼˜åŒ–
- **æ‰¹é‡æ›´æ–°**ï¼šåˆå¹¶DOMæ›´æ–°æ“ä½œï¼Œå‡å°‘é‡ç»˜å’Œå›æµ
- **è™šæ‹ŸDOM**ï¼šä½¿ç”¨è™šæ‹ŸDOMæŠ€æœ¯å‡å°‘å®é™…DOMæ“ä½œ
- **CSSä¼˜åŒ–**ï¼šé¿å…ä½¿ç”¨é«˜æˆæœ¬çš„CSSé€‰æ‹©å™¨å’Œå±æ€§
- **åŠ¨ç”»ä¼˜åŒ–**ï¼šä½¿ç”¨CSSåŠ¨ç”»æˆ–requestAnimationFrameä¼˜åŒ–åŠ¨ç”»æ€§èƒ½

## ğŸ§© æŠ€æœ¯çŸ©é˜µ

| æŠ€æœ¯ç‚¹ | åŸåˆ™å…³è” | æ¶æ„ä½ç½® | å¥‘çº¦æ¡æ¬¾ | å®ç°æ¨¡å— |
|---|---|---|---|---|
| å››çŠ¶æ€æ¨¡å‹ | åŸåˆ™1,3 | ç³»ç»Ÿæ¨¡å‹Â§2 | å¥‘çº¦Â§3.1 | çŠ¶æ€ç®¡ç† |
| é˜²æŠ–300ms | åŸåˆ™2 | å®æ–½æŒ‡å—Â§4 | å¥‘çº¦Â§4.5 | æ—¶åºæ§åˆ¶ |
| ä¸‰å±‚æ•°æ®æµ | åŸåˆ™1,5 | ç³»ç»Ÿæ¨¡å‹Â§1 | å¥‘çº¦Â§2.1 | æ•°æ®è½¬æ¢ |
| ç‰ˆæœ¬ç®¡ç† | åŸåˆ™5 | ç³»ç»Ÿæ¨¡å‹Â§4 | å¥‘çº¦Â§5.2 | é”™è¯¯å¤„ç† |
| å•ä¸€ç¼–è¾‘æƒ | åŸåˆ™3 | ç³»ç»Ÿæ¨¡å‹Â§2 | å¥‘çº¦Â§3.3 | çŠ¶æ€ç®¡ç† |
| é”™è¯¯æ¢å¤ä¼˜å…ˆçº§ | åŸåˆ™5 | ç³»ç»Ÿæ¨¡å‹Â§4 | å¥‘çº¦Â§6.1 | é”™è¯¯å¤„ç† |
| ç”¨æˆ·æ“ä½œä¼˜å…ˆ | åŸåˆ™2 | æ ¸å¿ƒåŸåˆ™Â§2 | å¥‘çº¦Â§4.1 | æ—¶åºæ§åˆ¶ |